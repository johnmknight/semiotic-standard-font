<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Glyph Redraw — Semiotic Standard</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #0a0a0a; color: #ccc; font-family: 'Courier New', monospace; padding: 30px; min-height: 100vh; }
  h1 { color: #f90; font-size: 13px; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 6px; }
  .sub { color: #555; font-size: 11px; margin-bottom: 30px; }
  .workspace { display: flex; gap: 30px; align-items: flex-start; flex-wrap: wrap; }
  .panel { background: #111; border: 1px solid #2a2a2a; border-radius: 4px; padding: 16px; min-width: 260px; }
  .panel-title { font-size: 10px; color: #f90; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px solid #222; padding-bottom: 8px; }
  #source-display { width: 220px; height: 220px; border: 1px solid #333; display: block; }
  #svg-container { width: 220px; height: 220px; border: 1px solid #333; background: #fff; display: flex; align-items: center; justify-content: center; }
  #svg-container svg { width: 200px; height: 200px; }
  .controls { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
  button { background: #1a1a1a; border: 1px solid #f90; color: #f90; font-family: 'Courier New', monospace; font-size: 11px; padding: 7px 14px; cursor: pointer; letter-spacing: 1px; text-transform: uppercase; transition: all 0.15s; }
  button:hover { background: #f90; color: #000; }
  button:disabled { border-color: #333; color: #333; cursor: not-allowed; }
  button:disabled:hover { background: #1a1a1a; color: #333; }
  #log { background: #080808; border: 1px solid #1e1e1e; border-radius: 3px; padding: 12px; font-size: 10px; color: #666; height: 160px; overflow-y: auto; margin-top: 16px; line-height: 1.6; }
  #log .info { color: #888; } #log .ok { color: #4f4; } #log .err { color: #f44; } #log .warn { color: #f90; }
  #svg-code { background: #080808; border: 1px solid #1e1e1e; border-radius: 3px; padding: 12px; font-size: 9px; color: #4a4; height: 200px; overflow: auto; margin-top: 12px; white-space: pre-wrap; word-break: break-all; }
  #compare { display: flex; gap: 20px; margin-top: 20px; align-items: flex-end; flex-wrap: wrap; }
  .compare-item { text-align: center; }
  .compare-label { font-size: 10px; color: #555; margin-top: 6px; letter-spacing: 1px; }
  .compare-label.hero { color: #f90; }
  .compare-box { border: 1px solid #2a2a2a; display: flex; align-items: center; justify-content: center; }
  .compare-box.white-bg { background: #fff; }
  .compare-box.dark-bg  { background: #111; }
  #iterations { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 10px; }
  .iter-thumb { cursor: pointer; border: 2px solid #222; transition: border-color 0.15s; }
  .iter-thumb:hover, .iter-thumb.active { border-color: #f90; }
  .iter-label { font-size: 9px; color: #555; text-align: center; margin-top: 3px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner { display: inline-block; width: 10px; height: 10px; border: 2px solid #333; border-top-color: #f90; border-radius: 50%; animation: spin 0.7s linear infinite; margin-right: 6px; vertical-align: middle; }
</style>
</head>
<body>
<h1>Semiotic Standard — Glyph Redraw</h1>
<p class="sub">Claude vision → clean SVG paths. No tracing. Pure geometric reconstruction.</p>
<div class="workspace">

  <div class="panel" style="flex:0 0 auto;">
    <div class="panel-title">Source</div>
    <img id="source-display" src="/svg/masks/grain/_source.png" alt="source">
    <div class="controls">
      <button id="btn-analyze">Analyse Glyph</button>
      <button id="btn-refine" disabled>Refine</button>
      <button id="btn-download" disabled>Export SVG</button>
    </div>
    <div id="log"><span class="info">Ready. Click Analyse to begin.</span></div>
  </div>

  <div class="panel" style="flex:0 0 auto;">
    <div class="panel-title">Reconstructed Glyph</div>
    <div id="svg-container"><span style="color:#333;font-size:10px;">awaiting render</span></div>
    <div id="compare">
      <div class="compare-item">
        <div class="compare-box white-bg" style="width:80px;height:80px;" id="cmp-white"></div>
        <div class="compare-label hero">on white</div>
      </div>
      <div class="compare-item">
        <div class="compare-box dark-bg" style="width:80px;height:80px;" id="cmp-dark"></div>
        <div class="compare-label">on dark</div>
      </div>
      <div class="compare-item">
        <div class="compare-box white-bg" style="width:80px;height:80px;">
          <img src="/svg/masks/grain/_source.png" style="width:80px;height:80px;object-fit:contain;">
        </div>
        <div class="compare-label">source</div>
      </div>
    </div>
    <div class="panel-title" style="margin-top:16px;">Iterations</div>
    <div id="iterations"></div>
  </div>

  <div class="panel" style="flex:1 1 300px;">
    <div class="panel-title">SVG Output</div>
    <div id="svg-code">// SVG paths will appear here</div>
  </div>

</div>

<script>
let currentSvg = null;
let iterationCount = 0;

function log(msg, type='info') {
  const el = document.getElementById('log');
  const line = document.createElement('div');
  line.className = type;
  line.innerHTML = (type === 'info' ? '' : `<span class="${type}">[${type.toUpperCase()}]</span> `) + msg;
  el.appendChild(line);
  el.scrollTop = el.scrollHeight;
}

async function getBase64(url) {
  const resp = await fetch(url);
  const blob = await resp.blob();
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.readAsDataURL(blob);
  });
}

function extractSvg(text) {
  let m = text.match(/```svg\s*([\s\S]+?)```/i);
  if (m) return m[1].trim();
  m = text.match(/(<svg[\s\S]+?<\/svg>)/i);
  if (m) return m[1].trim();
  return null;
}

function renderSvg(svgStr) {
  currentSvg = svgStr;
  const container = document.getElementById('svg-container');
  container.innerHTML = svgStr;
  const svgEl = container.querySelector('svg');
  if (svgEl) { svgEl.style.width = '200px'; svgEl.style.height = '200px'; }

  const blob = new Blob([svgStr], {type:'image/svg+xml'});
  const url = URL.createObjectURL(blob);
  ['cmp-white','cmp-dark'].forEach(id => {
    const el = document.getElementById(id);
    el.innerHTML = `<img src="${url}" style="width:76px;height:76px;object-fit:contain;">`;
  });

  document.getElementById('svg-code').textContent = svgStr;
  iterationCount++;

  // Iteration thumb
  const iters = document.getElementById('iterations');
  document.querySelectorAll('.iter-thumb').forEach(t => t.classList.remove('active'));
  const wrap = document.createElement('div');
  const svgBlob = new Blob([svgStr], {type:'image/svg+xml'});
  const thumbUrl = URL.createObjectURL(svgBlob);
  const savedSvg = svgStr;
  wrap.innerHTML = `<img src="${thumbUrl}" class="iter-thumb active" style="width:50px;height:50px;background:#fff;" title="v${iterationCount}"><div class="iter-label">v${iterationCount}</div>`;
  wrap.querySelector('img').addEventListener('click', () => {
    document.querySelectorAll('.iter-thumb').forEach(t => t.classList.remove('active'));
    wrap.querySelector('img').classList.add('active');
    document.getElementById('svg-container').innerHTML = savedSvg;
    const s = document.getElementById('svg-container').querySelector('svg');
    if (s) { s.style.width='200px'; s.style.height='200px'; }
    document.getElementById('svg-code').textContent = savedSvg;
    currentSvg = savedSvg;
  });
  iters.appendChild(wrap);

  document.getElementById('btn-refine').disabled = false;
  document.getElementById('btn-download').disabled = false;
}

function buildPrompt(isRefinement, previousSvg, feedback) {
  const base = `You are a precise SVG illustrator specialising in iconographic glyphs.

You will receive an image of a hand-drawn Semiotic Standard icon by Ron Cobb (1979 Alien franchise).
Your task: study the INTERNAL GLYPH ONLY — ignore the frame border, label panel, and any text.
Reconstruct that glyph as clean SVG paths from scratch using your drawing skills.

RULES:
- viewBox="0 0 100 100"
- Fill: black (#000000) only. No stroke. fill-rule="evenodd"
- Centre the glyph with ~10% margin on all sides
- Use smooth bezier curves where shapes are curved; straight lines where straight
- Capture the essential character — proportions, weight, distinctive features
- Output ONLY the SVG element. No explanation, no markdown fences, no extra text.

GLYPH: Wheat/grain stalk, vertically oriented.
- Central vertical stem
- ~6-7 pairs of grain kernels symmetrically along the stem (classic wheat ear shape)
- Each kernel is an almond/oval angling slightly outward from stem
- Top: 3-4 thin vertical awns (bristles) extending upward
- Overall silhouette: torpedo-shaped, wider in middle, tapering top and bottom
- Style: bold, graphic, clean — not realistic

Output a single <svg> element only.`;

  if (isRefinement && previousSvg) {
    return base + `\n\nPREVIOUS ATTEMPT:\n${previousSvg}\n\nFEEDBACK: ${feedback || 'Improve proportions and shape accuracy to better match the source glyph.'}\n\nProduce an improved version.`;
  }
  return base;
}

async function callClaude(isRefinement = false, feedback = '') {
  const btnA = document.getElementById('btn-analyze');
  const btnR = document.getElementById('btn-refine');
  const btnD = document.getElementById('btn-download');
  btnA.disabled = true; btnR.disabled = true;

  log(`<span class="spinner"></span>${isRefinement ? 'Refining' : 'Analysing'}...`);

  try {
    const imgB64 = await getBase64('/svg/masks/grain/_source.png');
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2000,
        messages: [{
          role: 'user',
          content: [
            { type: 'image', source: { type: 'base64', media_type: 'image/png', data: imgB64 } },
            { type: 'text', text: buildPrompt(isRefinement, currentSvg, feedback) }
          ]
        }]
      })
    });

    if (!resp.ok) throw new Error(`API ${resp.status}: ${await resp.text()}`);
    const data = await resp.json();
    const text = data.content?.map(b => b.text || '').join('') || '';
    log(`Response (${text.length} chars)`, 'ok');

    const svg = extractSvg(text);
    if (!svg) {
      log('Could not extract SVG:', 'err');
      document.getElementById('svg-code').textContent = text.substring(0, 500);
      return;
    }
    log(`SVG extracted — v${iterationCount + 1}`, 'ok');
    renderSvg(svg);

  } catch(e) {
    log('Error: ' + e.message, 'err');
  } finally {
    btnA.disabled = false;
    btnR.disabled = currentSvg === null;
    btnD.disabled = currentSvg === null;
  }
}

document.getElementById('btn-analyze').addEventListener('click', () => callClaude(false));
document.getElementById('btn-refine').addEventListener('click', () => {
  const fb = prompt('What to improve? (leave blank for default):') || '';
  callClaude(true, fb);
});
document.getElementById('btn-download').addEventListener('click', () => {
  if (!currentSvg) return;
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([currentSvg], {type:'image/svg+xml'}));
  a.download = `ss-grain-v${iterationCount}.svg`;
  a.click();
});
</script>
</body>
</html>
